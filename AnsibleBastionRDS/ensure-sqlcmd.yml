- name: Ensure sqlcmd is installed and configured on Windows EC2
  hosts: windows
  gather_facts: no


  tasks:

   - name: Check if sqlcmd is already installed
     win_stat:
      path: "C:\\Program Files\\sqlcmd\\sqlcmd.exe"
     register: sqlcmd_check

   - name: Install chocolatey (only if sqlcmd is absent)
     win_chocolatey:
       name: chocolatey
       state: present
     when: not sqlcmd_check.stat.exists

   - name: Install sqlcmd using Chocolatey (if sqlcmd is absent)
     win_chocolatey:
        name: sqlcmd
        state: present
     when: not sqlcmd_check.stat.exists

   - name: Ensure System32, Powershell and SqlCmd exists in system path
     win_environment:
       name: Path
       state: present
       level: machine
       value: "C:\\Windows\\System32;C:\\Windows\\System32\\WindowsPowerShell\\v1.0;C:\\Program Files\\sqlcmd"

   - name: Reboot System to apply changes to the environment
     win_reboot:
       msg: "Rebooting the system"
       reboot_timeout: 600
       connect_timeout: 600
       post_reboot_delay: 60
     when: not sqlcmd_check.stat.exists 
     ignore_errors: true

   - name: Wait for WinRM to become available after reboot
     wait_for_connection:
       timeout: 300

   - name: confirm sqlcmd is callable from powershell
     win_shell: sqlcmd -?
     register: sqlcmd_output

   - name: Display sqlcmd help output
     debug:
       var: sqlcmd_output.stdout
